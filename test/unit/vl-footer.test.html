<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>
  <script src="../../node_modules/sinon/pkg/sinon.js"></script>
</head>

<body>
  <test-fixture id="vl-footer-fixture">
    <template>
      <vl-footer data-vl-identifier="0337f8dc-3266-4e7a-8f4a-95fd65189e5b"></vl-footer>
    </template>
  </test-fixture>

  <test-fixture id="vl-footer-development-fixture">
    <template>
      <vl-footer data-vl-identifier="0337f8dc-3266-4e7a-8f4a-95fd65189e5b" data-vl-development></vl-footer>
    </template>
  </test-fixture>

  <script type="module">
    import fetchMock from '../../node_modules/fetch-mock/esm/client.mjs';
    import {VlFooter} from '../../src/vl-footer.js';

    suite('vl-footer', () => {
      const should = chai.should();
      const sandbox = sinon.createSandbox();
      const url = 'https://prod.widgets.burgerprofiel.vlaanderen.be/api/v1/widget/0337f8dc-3266-4e7a-8f4a-95fd65189e5b/embed';
      const devUrl = 'https://tni.widgets.burgerprofiel.dev-vlaanderen.be/api/v1/widget/0337f8dc-3266-4e7a-8f4a-95fd65189e5b/embed';

      setup((done) => {
        customElements.whenDefined('vl-footer').then(() => done());
      });

      teardown(() => {
        sandbox.restore();
        fetchMock.restore();
      });

      test('haalt de Webuniversum embed code op, voorziet een placholder en voert de code uit', () => {
        const message = 'code werd uitgevoerd!';
        fetchMock.mock(url, 'console.log("' + message + '")');
        fixture('vl-footer-fixture');
        sandbox.spy(console, 'log');
        should.not.exist(document.body.querySelector('#' + VlFooter.id));
        return fetchMock.flush(true).then(() => {
          should.exist(document.body.querySelector('#' + VlFooter.id));
          assert(console.log.calledWith(message));
        });
      });

      test('toont een console foutmelding wanneer het ophalen van de Webuniversum embed code niet lukt', () => {
        fetchMock.mock(url, 404);
        fixture('vl-footer-fixture');
        sandbox.spy(console, 'error');
        return fetchMock.flush().then(() => {
          assert(console.error.called);
        });
      });

      test('indien het development attribuut aanwezig is zal de development AIV server aangesproken worden', () => {
        const mock = fetchMock.mock(devUrl, 200);
        fixture('vl-footer-development-fixture');
        return fetchMock.flush().then(() => {
          assert.isFalse(mock.called(url));
          assert.isTrue(mock.called(devUrl));
        });
      });
    });
  </script>
</body>

</html>
